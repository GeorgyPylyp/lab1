package com.example.myapplication3;

import android.os.Bundle;
import android.os.CountDownTimer;
import android.widget.Button;
import android.widget.CheckBox;
import android.widget.ProgressBar;
import android.widget.RadioGroup;
import android.widget.TextView;
import android.widget.Toast;
import android.widget.ToggleButton;

import androidx.appcompat.app.AppCompatActivity;

import java.util.ArrayList;
import java.util.Random;

public class MainActivity extends AppCompatActivity {

    TextView tvQuestion, tvScore, tvTimer;
    Button btnTrue, btnFalse, btnRestart;
    CheckBox cbNoRepeat;
    ToggleButton toggleTimer;
    RadioGroup rgDifficulty;
    ProgressBar progressBar;

    String[] questions = {
            "–ú–∏–∫–æ–ª–∞ –õ–∏—Å–µ–Ω–∫–æ —î –∑–∞—Å–Ω–æ–≤–Ω–∏–∫–æ–º —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—ó –∫–ª–∞—Å–∏—á–Ω–æ—ó –º—É–∑–∏–∫–∏.",
            "–ö–æ–±–∑–∞—Ä—Å—Ç–≤–æ –≤–∏–Ω–∏–∫–ª–æ —É XX —Å—Ç–æ–ª—ñ—Ç—Ç—ñ.",
            "–û–ø–µ—Ä—É ¬´–ó–∞–ø–æ—Ä–æ–∂–µ—Ü—å –∑–∞ –î—É–Ω–∞—î–º¬ª –Ω–∞–ø–∏—Å–∞–≤ –°–µ–º–µ–Ω –ì—É–ª–∞–∫-–ê—Ä—Ç–µ–º–æ–≤—Å—å–∫–∏–π.",
            "–ú–∏–∫–æ–ª–∞ –õ–µ–æ–Ω—Ç–æ–≤–∏—á —î –∞–≤—Ç–æ—Ä–æ–º ¬´–©–µ–¥—Ä–∏–∫–∞¬ª.",
            "–ë–∞–Ω–¥—É—Ä–∞ –Ω–∞–ª–µ–∂–∏—Ç—å –¥–æ –¥—É—Ö–æ–≤–∏—Ö —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤.",
            "–¢–∞—Ä–∞—Å –®–µ–≤—á–µ–Ω–∫–æ –Ω–∞–ø–∏—Å–∞–≤ ¬´–ö–æ–±–∑–∞—Ä¬ª.",
            "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –Ω–∞—Ä–æ–¥–Ω–∞ –ø—ñ—Å–Ω—è ¬´–ù–µ—Å–µ –ì–∞–ª—è –≤–æ–¥—É¬ª —î –∂–∞—Ä—Ç—ñ–≤–ª–∏–≤–æ—é.",
            "–õ–µ—Å—è –£–∫—Ä–∞—ó–Ω–∫–∞ –±—É–ª–∞ –ø–æ–µ—Ç–µ—Å–æ—é —ñ –¥—Ä–∞–º–∞—Ç—É—Ä–≥–æ–º.",
            "–ì—ñ–º–Ω –£–∫—Ä–∞—ó–Ω–∏ –Ω–∞–ø–∏—Å–∞–≤ –ú–∏—Ö–∞–π–ª–æ –í–µ—Ä–±–∏—Ü—å–∫–∏–π.",
            "–Ü–≤–∞–Ω –§—Ä–∞–Ω–∫–æ –±—É–≤ –ª–∏—à–µ –ø–æ–µ—Ç–æ–º."
    };

    boolean[] answers = {
            true,
            false,
            true,
            true,
            false,
            true,
            true,
            true,
            true,
            false
    };

    Random random = new Random();
    ArrayList<Integer> usedQuestions = new ArrayList<>();

    int score = 0;
    int asked = 0;
    int maxQuestions = 5;
    int currentIndex;

    boolean gameActive = true;
    CountDownTimer timer;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        tvQuestion = findViewById(R.id.tvQuestion);
        tvScore = findViewById(R.id.tvScore);
        tvTimer = findViewById(R.id.tvTimer);

        btnTrue = findViewById(R.id.btnTrue);
        btnFalse = findViewById(R.id.btnFalse);
        btnRestart = findViewById(R.id.btnRestart);

        cbNoRepeat = findViewById(R.id.cbNoRepeat);
        toggleTimer = findViewById(R.id.toggleTimer);
        rgDifficulty = findViewById(R.id.rgDifficulty);
        progressBar = findViewById(R.id.progressBar);

        btnTrue.setOnClickListener(v -> checkAnswer(true));
        btnFalse.setOnClickListener(v -> checkAnswer(false));
        btnRestart.setOnClickListener(v -> resetGame());

        toggleTimer.setOnCheckedChangeListener((buttonView, isChecked) -> {
            if (isChecked) startTimer();
            else stopTimer();
        });

        // üî• –ì–û–õ–û–í–ù–ï: –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ –≥—Ä–∞ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ
        rgDifficulty.setOnCheckedChangeListener((group, checkedId) -> {
            resetGame();
        });

        resetGame();
    }

    void resetGame() {
        stopTimer();

        score = 0;
        asked = 0;
        gameActive = true;
        usedQuestions.clear();

        if (rgDifficulty.getCheckedRadioButtonId() == R.id.rbHard) {
            maxQuestions = 10;
        } else {
            maxQuestions = 5;
        }

        tvScore.setText("Score: 0");
        tvTimer.setText("");
        progressBar.setMax(maxQuestions);
        progressBar.setProgress(0);

        btnTrue.setEnabled(true);
        btnFalse.setEnabled(true);

        if (toggleTimer.isChecked()) {
            startTimer();
        }

        showQuestion();
    }

    void showQuestion() {
        if (!gameActive) return;

        if (asked == maxQuestions) {
            endGame();
            return;
        }

        do {
            currentIndex = random.nextInt(questions.length);
        } while (cbNoRepeat.isChecked() && usedQuestions.contains(currentIndex));

        usedQuestions.add(currentIndex);
        tvQuestion.setText(questions[currentIndex]);
    }

    void checkAnswer(boolean userAnswer) {
        if (!gameActive) return;

        if (userAnswer == answers[currentIndex]) {
            score++;
        }

        asked++;
        tvScore.setText("Score: " + score);
        progressBar.setProgress(asked);

        showQuestion();
    }

    void startTimer() {
        stopTimer();

        int time;
        if (rgDifficulty.getCheckedRadioButtonId() == R.id.rbHard) {
            time = 30000; // 30 —Å–µ–∫
        } else {
            time = 60000; // 60 —Å–µ–∫
        }

        timer = new CountDownTimer(time, 1000) {
            @Override
            public void onTick(long millisUntilFinished) {
                tvTimer.setText("Time: " + millisUntilFinished / 1000 + "s");
            }

            @Override
            public void onFinish() {
                tvTimer.setText("Time over");
                endGame();
            }
        }.start();
    }

    void stopTimer() {
        if (timer != null) {
            timer.cancel();
            timer = null;
        }
        tvTimer.setText("");
    }

    void endGame() {
        gameActive = false;
        btnTrue.setEnabled(false);
        btnFalse.setEnabled(false);
        stopTimer();

        Toast.makeText(
                this,
                "–ì—Ä—É –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –†–µ–∑—É–ª—å—Ç–∞—Ç: " + score + " –∑ " + maxQuestions,
                Toast.LENGTH_LONG
        ).show();
    }
}
